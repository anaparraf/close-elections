---
title: "close_election"
author: "K"
date: "2024-04-25"
output: html_document
---

importando bibliotecas e abrindo bases

```{r comeco, warning=FALSE, message=FALSE}

library(readxl)
library(tidyverse)
library(reshape2)
library(writexl)
library(broom)
library(rdrobust)
library(rddensity)
library(modelsummary)
library(tidyverse)
library(rdd)


setwd("D:/OneDrive/Data/Insper_Data/Close_elections/Dados/municipios")
```

## Total de Votantes

### Dados Brutos - Populacao eleitoral

Puxando a base diretamente da library electionsBR e salvando no csv: n_eleitores_mandato.csv

```{r, warning=FALSE, message=FALSE}

# library(electionsBR)
# 
# n_eleitores <- function(year) {
#   elections_tse(year, type = 'details_mun_zone', uf = 'all')}
# 
# year = c(2000, 2004, 2008, 2012, 2016, 2020)
# 
# n_eleitores_mandato <- map_df(year, n_eleitores)
# 
# write.csv(n_eleitores_mandato, file = 'populacao_votante.csv', row.names = FALSE)
# 
# n_eleitores_mandato <- read_csv('populacao_votante.csv')
```

### Filtragem do total de votantes

Aqui, com base na base extraida anteriormente, foram feitas as modificacoes e filtragens necessarias para a analise. Salvas tambem no csv: total_votantes.csv

```{r, warning=FALSE, message=FALSE}

# total_votantes <- n_eleitores_mandato |>
#   rename(cargo = DS_CARGO,
#          municipio = NM_MUNICIPIO,
#          total_votantes = QT_APTOS,
#          ano = ANO_ELEICAO,
#          zona = NR_ZONA,
#          abstencoes = QT_ABSTENCOES) |>
#   filter(cargo == 'Prefeito') |>
#   group_by(ano, municipio, zona) |>
#     summarise(total_votantes = max(total_votantes),
#               total_abstencoes = max(abstencoes)) |>
#   group_by(ano, municipio) |>
#   summarise(total_votantes = sum(total_votantes),
#             total_abstencoes = sum(total_abstencoes),
#             tx_abstencao = total_abstencoes/total_votantes)
# 
# write.csv(total_votantes, file = 'total_votantes.csv', row.names = FALSE)
# 
# total_votantes <- read.csv('total_votantes.csv')


```

## Margem de Vitoria

### raw elections info

Extraindo e salvando todos os dados das eleicoes municipais de 2000 a 2020 - Salvas em elections_info.csv

```{r}
# library(electionsBR)
# 
# function_elections_info <- function(year) {
#   elections_tse(year, uf='all', type = 'vote_mun_zone')
#   }
# 
# year = c(2000, 2004, 2008, 2012, 2016, 2020)
# 
# elections_info <- map_df(year, function_elections_info)
# 
# write.csv(elections_info, file = 'elections_info.csv', row.names = FALSE)
# # 
# 
# elections_info <- read.csv('elections_info.csv')
# 
# elections_info |> head(5)
```

### candidates info

```{r}

# library(electionsBR)
# 
# function_candidates_info <- function(year) {
#   candidate_local(year, uf='all') |>
#     mutate(NR_PROTOCOLO_CANDIDATURA = as.character(NR_PROTOCOLO_CANDIDATURA),
#            NR_CPF_CANDIDATO = as.character(NR_CPF_CANDIDATO),
#            CD_COR_RACA = as.character(CD_COR_RACA))}
# 
# year = c(2000, 2004, 2008, 2012, 2016, 2020)
# 
# candidates_info <- map_df(year, function_candidates_info)
# 
# write.csv(candidates_info, file = 'candidates_info.csv', row.names = FALSE)
# 
# 
# candidates_info <- read.csv('candidates_info.csv')
# 
# candidates_info |> head(5)
```

### Filtrando e ajustando a base com informacoes sobre os candidatos

```{r}

# candidates <- candidates_info %>%
#   rename(
#     ano = ANO_ELEICAO,
#     estado = SG_UF,
#     cargo = DS_CARGO,
#     candidato = NM_CANDIDATO,
#     genero = DS_GENERO,
#     partido = SG_PARTIDO,
#     idade = NR_IDADE_DATA_POSSE,
#     educacao = DS_GRAU_INSTRUCAO) %>%
#   filter(ano >= 2000 & ano <= 2016,
#          cargo == 'PREFEITO')  %>%
#   select(ano, estado, candidato, genero, partido, idade, educacao) %>%
#   group_by(ano, estado, candidato) %>%
#   summarise(genero = first(genero),
#             partido = first(partido),
#             idade = first(idade),
#             educacao = first(educacao))


```

```{r}


# elections_info <- read.csv('elections_info.csv')
 
# tse_ibge_muni <- read.csv('municipios_brasileiros_tse.csv')
# 
# 
# elections_results <- elections_info %>%
#   mutate(qt_votos = case_when(ANO_ELEICAO == 2000 ~ QT_VOTOS_NOMINAIS_VALIDOS,
#                                .default = QT_VOTOS_NOMINAIS)) |> 
#   rename(ano = ANO_ELEICAO,
#     estado = SG_UF,
#     cargo = DS_CARGO,
#     municipio = NM_MUNICIPIO,
#     cd_municipio = CD_MUNICIPIO,
#     zona = NR_ZONA,
#     candidato = NM_CANDIDATO,
#     votos = qt_votos) %>%
#   filter(ano >= 2000 & ano <= 2016,
#     cargo == 'Prefeito') |>
#   select(ano, estado,  municipio, cd_municipio, zona, candidato, votos) %>%
#   left_join(candidates, by = c('ano', 'estado', 'candidato')) |>
#   group_by(ano, estado, municipio, candidato) %>%
#   summarise(cd_municipio = first(cd_municipio),
#             votos_totais = sum(votos),
#             genero = first(genero),
#             partido = first(partido),
#             idade = first(idade),
#             educacao = first(educacao)) %>%
#   arrange(ano, estado, municipio, desc(votos_totais)) %>%
#   slice_max(order_by = votos_totais, n = 2) %>%
#   mutate(margem = votos_totais/sum(votos_totais)) %>%
#   group_by(ano, estado, municipio) %>%
#   summarise(
#     cd_municipio = first(cd_municipio),
#     nome_eleito = first(candidato),
#     partido_eleito = first(partido),
#     idade_eleito = first(idade),
#     educacao_eleito = first(educacao),
#     cont_fem = sum(genero == 'FEMININO'),
#     margem_fem = sum(margem[genero == "FEMININO"]),
#     margem_mas = sum(margem[genero == "MASCULINO"]),
#     margem_vitoria_mulher = (margem_fem - margem_mas),
#     mulher_eleita = margem_vitoria_mulher > 0 ,
#     .groups = 'drop') %>%
#   filter(cont_fem == 1) |>
#   select(ano, estado, municipio, margem_vitoria_mulher, everything(),-cont_fem,-margem_fem,-margem_mas) |>
#   left_join(total_votantes, by=c('municipio', 'ano')) |>
#   left_join(tse_ibge_muni, by=c('cd_municipio' = 'codigo_tse')) |>
#   select(-uf, -nome_municipio, -capital)
# 
# write.csv(elections_results, file = 'elections_results.csv', row.names = FALSE)
# 
# 
pop <- read_xlsx('estimativa_pop_municipio.xlsx', sheet = 'Planilha1')
# 
# muni_pop <- pop |>
#   rename(municipio = Município) |>
#   mutate(cd_municipio = substr(municipio, 1, 6),
#          municipio = substr(municipio,8, nchar(municipio))) |>
#   melt(c('cd_municipio','municipio'))  |>
#   rename(ano = variable,
#          pop = value) |>
#   mutate(municipio = iconv(municipio, from = "UTF-8", to = "ASCII//TRANSLIT"),
#        municipio = str_replace_all(municipio, "[^A-Za-z0-9 ]", ""))


elections_results <- read.csv('elections_results.csv')


```




### graficos

```{r }

# 1 - partido 
elections_results |> 
  count(partido_eleito, sort = TRUE) |>
  head(10) |> 
  mutate(partido_eleito = fct_reorder(partido_eleito, n)) |>  
  ggplot(aes(partido_eleito, n)) +
  geom_col() + 
  coord_flip()
  
# 2 - partido
elections_results %>%
  count(partido_eleito, mulher_eleita, sort = TRUE) %>%
  group_by(partido_eleito) %>%
  mutate(total = sum(n)) %>%
  ungroup() %>%
  mutate(partido_eleito = fct_reorder(partido_eleito, total, .desc = TRUE)) %>%
  slice_max(order_by = total, n = 20) %>%
  ggplot(aes(x = partido_eleito, y = n, fill = mulher_eleita)) +  # Fill based on gender
  geom_col(show.legend = TRUE, position = 'dodge') +  # Show legend to distinguish male/female
  coord_flip() +
  labs(title = "Eleições Ganhas - Homens x Mulheres",
       x = "Partido",
       y = "Numero de eleições ganhas",
       fill = "Mulher eleita")


# 3 - ano 
elections_results |> 
  ggplot(aes(x = as.factor(ano), fill = mulher_eleita)) + 
  geom_bar(position = 'stack')


# 4 - estado 
elections_results %>%
  mutate(estado = fct_rev(fct_infreq(as.factor(estado)))) %>%  
  ggplot(aes(x = estado, fill = mulher_eleita)) +
  geom_bar() +
  ggtitle('...')+
  coord_flip() 
  

# 5 - estado 

library(scales)

elections_results %>%
  mutate(estado = fct_rev(fct_infreq(as.factor(estado)))) %>%  
  ggplot(aes(x = estado, fill = mulher_eleita)) +
  geom_bar(position = 'fill') +
  coord_flip() +
  labs(x = "Estado", y = "Proporção", fill = "Mulher Eleita?") +
  geom_hline(yintercept = .50, linetype = "dashed", color = "yellow", linewidth = 1) +
  scale_y_continuous(labels = percent)

# 6 - idade
# melhorar, botar a media de cada grupo por exemplo.

elections_results %>%
  ggplot(aes(idade_eleito, fill = mulher_eleita)) + 
  geom_density(data = . %>% filter(mulher_eleita == TRUE), color = "blue", size = 1, alpha = 1) +  
  geom_density(data = . %>% filter(mulher_eleita == FALSE), color = "red", size = 1, alpha = .78) +
  labs(title = "idade_eleito",
       x = "idade",  
       y = "Frequência") +  
  theme_minimal() +
  lims(x = c(18, 80))


# 7 - escolaridade
# MELHORAR ESSA VISUALIZACAO PELO AMOR DE DEUS!!!!!!!!!!!! Mas informacoes mt valiosas
elections_results %>%
  ggplot(aes(x = mulher_eleita, fill = educacao_eleito)) +
  geom_bar() +
  ggtitle('...')+
  coord_flip() 

# 8 - abstencao

elections_results %>%
  ggplot(aes(tx_abstencao, fill = mulher_eleita)) + 
  geom_density(data = . %>% filter(mulher_eleita == TRUE), color = "blue", size = 1, alpha = 1) +  
  geom_density(data = . %>% filter(mulher_eleita == FALSE), color = "red", size = 1, alpha = .78) +
  labs(title = "Distribuição das Abstenções",
       x = "Tx_abstencao",  
       y = "Frequência") +  
  theme_minimal() +
  lims(x = c(0, 0.3))


```

### Rotulos para fazer o join com a base elections_results

```{r}
# library(stringr)
# library(stringi)
# 
# rotulo_muni2005 <- read_excel('cd_muni_pre_2005.xls')
# 
# 
# rotulo2005 <- rotulo_muni2005 |> 
#   rename(cd_municipio = `Código Município Completo`,
#          nm_municipio = Nome_Município) |> 
#   mutate(nm_municipio = iconv(nm_municipio, from = "UTF-8", to = "ASCII//TRANSLIT"),
#          nm_municipio = str_replace_all(nm_municipio, "[^A-Za-z0-9 ]", ""),
#          nm_municipio = toupper(nm_municipio))
# 
# pop <- read_xlsx('estimativa_pop_municipio.xlsx', sheet = 'Planilha1')
# 
# 
# rotulo <- pop |>  
#   rename(municipio = Município) |> 
#   mutate(cd_municipio = substr(municipio, 1, 6),
#          municipio = substr(municipio,8, nchar(municipio))) |> 
#   melt(c('cd_municipio','municipio'))  |>  
#   rename(ano = variable,
#          pop = value) |>  
#   mutate(municipio = iconv(municipio, from = "UTF-8", to = "ASCII//TRANSLIT"),
#        municipio = str_replace_all(municipio, "[^A-Za-z0-9 ]", "")) |> 
#   select(cd_municipio, municipio) |> 
#   rename(nm_municipio = municipio)
# 
# 
# datasus <- read.csv('datasus_completo.csv')
# 
# 
# rotulo_final <- datasus |> 
#   mutate(municipio = as.character(municipio),
#          idade = as.character(idade),
#   idade = substr(idade, 2, 3)) |> 
#   group_by(municipio) |>
#   summarise() |> 
#   left_join(rotulo2005, by = c('municipio' = 'cd_municipio')) |> 
#   left_join(rotulo, by = c('municipio' = 'cd_municipio')) |> 
#   mutate(nm_municipio = coalesce(nm_municipio.x, nm_municipio.y))  |> 
#   select(-nm_municipio.x, -nm_municipio.y) |> 
#   group_by(municipio) |> 
#   summarise(nm_municipio = first(nm_municipio)) 



```

### FILTRANDO HOMICIDIOS

```{r}

# domestic_homicide <- datasus |> 
#   mutate(municipio = as.character(municipio),
#          idade = as.character(idade),
#          idade = substr(idade, 2, 3),
#          idade = as.numeric(idade),
#          municipio = as.character(municipio),
#          estado = substr(municipio, 1,2)) |> 
#   left_join(rotulo_final, by = c('municipio')) |> 
#   select(data, ano_obito, estado, municipio, nm_municipio, everything()) |>
#   filter(idade >= 15 & idade <= 49, 
#          local == 3,
#          sexo == 2,# ambiente domestico
#          ano_obito <= 2020 & ano_obito > 2000) |> # somente 3 mandatos. 2004, 2008, 2012 
#   group_by(mandato, estado , nm_municipio) |> 
#   summarize(domestic_homicides = n())
# 
# all_homicide <- datasus |> 
#   mutate(municipio = as.character(municipio),
#          idade = as.character(idade),
#          idade = substr(idade, 2, 3),
#          idade = as.numeric(idade),
#          municipio = as.character(municipio),
#          estado = substr(municipio, 1,2)) |> 
#   left_join(rotulo_final, by = c('municipio')) |> 
#   select(data, ano_obito, estado, municipio, nm_municipio, everything()) |>
#   filter(idade >= 15 & idade <= 49, # ambiente domestico
#          ano_obito <= 2020 & ano_obito > 2000,
#          sexo == 2) |> 
#   group_by(mandato, estado , nm_municipio) |> 
#   summarize(all_homicides = n())
# 
# 
# 
# datasus_final <- domestic_homicide |>
#   left_join(all_homicide, by= c('mandato', 'estado', 'nm_municipio')) |> 
#   mutate(estado = as.character(estado))
# 
# write.csv(datasus_final, file = 'datasus_final.csv', row.names = FALSE)

datasus_final <- read.csv('datasus_final.csv') |> 
    mutate(estado = as.character(estado))




```


### juntando com a base principal

```{r}
muni_pop <- pop |>  
  rename(municipio = Município) |> 
  mutate(cd_municipio = substr(municipio, 1, 6),
         municipio = substr(municipio,8, nchar(municipio))) |> 
  melt(c('cd_municipio','municipio'))  |>  
  rename(ano = variable,
         pop = value) |>
  select(-municipio) |> 
  mutate(pop = ifelse(pop == '-', NA, as.numeric(pop))) |> 
  arrange(cd_municipio, ano) |> 
  group_by(cd_municipio) |> 
  fill(pop, .direction = 'up') 

```


```{r}

elections_final <- elections_results %>%
  mutate(ano_t_1 = case_when(ano == 2004 ~ 2000,
                             ano == 2008 ~ 2004,
                             ano == 2012 ~ 2008,
                             ano == 2016 ~ 2012,
                             ano == 2020 ~ 2016,
                             .default = NA)) |> 
  mutate(municipio = iconv(municipio, from = "UTF-8", to = "ASCII//TRANSLIT"),
         municipio = str_replace_all(municipio, "[^A-Za-z0-9 ]", ""),
         municipio = str_replace_all(municipio, "\\bD ", "D"),
         municipio = trimws(municipio, which = "right"),
         codigo_ibge = as.character(codigo_ibge),
         cd_estado = substr(codigo_ibge,1,2)) %>%
  left_join(datasus_final, by=c('ano' = 'mandato', 'cd_estado' = 'estado', 'municipio' = 'nm_municipio')) %>%
  select(ano, estado, municipio, codigo_ibge, domestic_homicides, all_homicides, margem_vitoria_mulher, everything()) |> 
  mutate(all_homicides = replace_na(all_homicides, 0),
         domestic_homicides = replace_na(domestic_homicides, 0),
         codigo_ibge = as.character(codigo_ibge),
         codigo_ibge_att = substr(codigo_ibge, 1, 6),
         ano = as.factor(ano)) |> 
  left_join(muni_pop, by=c('codigo_ibge_att' = 'cd_municipio', 'ano')) |> 
  mutate(pop = as.integer(pop),
         tx_homicidio_domestico = (domestic_homicides/pop)*100000,
         tx_homicidio_geral = (all_homicides/pop)*100000) |> 
  select(ano, estado, municipio, margem_vitoria_mulher, tx_homicidio_domestico, tx_homicidio_geral, everything(), -cd_municipio) |> 
  filter(total_votantes < 200000) |>
  left_join(datasus_final, by=c('ano_t_1' = 'mandato', 'cd_estado' = 'estado', 'municipio' = 'nm_municipio')) |> 
  rename(domestic_homicides = domestic_homicides.x,
         all_homicides = all_homicides.x,
         domestic_homicides_t1 = domestic_homicides.y,
         all_homicides_t1 = all_homicides.y) |> 
  mutate(all_homicides_t1 = replace_na(all_homicides_t1, 0),
         domestic_homicides_t1 = replace_na(domestic_homicides_t1, 0),
         tx_homicidio_domestico_t1 = (domestic_homicides_t1/pop)*100000,
         tx_homicidio_geral_t1 = (all_homicides_t1/pop)*100000) |> 
  select(ano, estado, municipio, margem_vitoria_mulher,tx_homicidio_domestico ,tx_homicidio_domestico_t1, tx_homicidio_geral, tx_homicidio_geral_t1, everything()) |> 
  filter(ano != 2000 & ano != 2016) |> 
  arrange(municipio)

elections_final

```



```{r}

elections_results |> 
  ggplot(aes(x = as.factor(ano), fill = mulher_eleita)) + 
  geom_bar(position = 'stack') +
  geom_vline(xintercept = 0) + 
  scale_fill_manual(values = c("#7373ff", "#ff7373"),
                    labels = c("Male Elected", "Female Elected")) +
  labs(title = "Victory Margins in Brazilian Municipal Elections",
       subtitle = "Mayoral runs between men and women (2004 - 2016)",
       x = "Women's Margin of Victory",
       y = NULL,
       color = 'Woman Elected',
       fill = NULL,
       caption = "By InsperData") +
  theme_minimal() 

```

```{r}

elections_final |> 
  filter(ano != 2000 & ano != 2016) |> 
  ggplot(aes(x = margem_vitoria_mulher, fill=mulher_eleita)) +
  geom_histogram(binwidth =.05, boundary = 0, color = 'white') +
  geom_vline(xintercept = 0, color = 'black') + 
  scale_fill_manual(values = c("#7373ff", "#ff7373"),
                    labels = c("Homem Eleito", "Mulher Eleita")) +
  labs(title = "Distribuição de Margens de Vitória em Municípios Brasileiros",
       subtitle = "Eleições entre Homens e Mulheres (2004 - 2012)",
       x = "Margem de Vitória de Mulheres",
       y = NULL,
       color = 'Woman Elected',
       fill = NULL) + 
       theme_minimal() + 
  theme(legend.position = "top",
        plot.caption = element_text(color = "#3494ba", size = 11),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 11, color = 'black'),
        axis.title.y = element_text(margin = margin(r = 10, unit = "pt"), size = 11), 
        axis.title.x = element_text(margin = margin(t = 10, unit = "pt"), size = 11),
        text=element_text(family="Segoe UI", size=12)) +
  scale_x_continuous(labels = scales::percent)
```
```{r}

candidatas_graf <- read_csv("candidatas_graf.csv")



candidatas_graf |> 
  filter(genero == 'FEMININO') |> 
  group_by(ano, eleito) |> 
  summarise(count = n()) |> 
  mutate(prop = count / sum(count))



candidatas_graf |>
  filter(genero == 'FEMININO') |> 
  group_by(ano, eleito) |> 
  summarise(n = n()) |> 
  mutate(rep = paste(round(n/sum(n),3)*100,'%'))|>
  group_by(ano) |> 
  mutate(n2 = ifelse(eleito == 'eleito', sum(n), n)) |> 
  ggplot(aes(x = as.factor(ano), fill = eleito, label = rep)) +
  geom_col(aes(y = n)) +
  geom_text(aes(y = n2), color = "white", fontface = "bold", nudge_y = -75) +
  labs(title= 'candidatas e eleitas',
       color= 'mulher eleita') +
  scale_fill_manual(values = c("#ff7373", "#bf7070"),
                    labels = c("Mulher Eleita", "Candidatas")) +
  labs(title = "Distribuição de Margens de Vitória em Municípios Brasileiros",
       subtitle = "Eleições entre Homens e Mulheres (2004 - 2012)",
       x = NULL,
       y = NULL,
       color = 'Woman Elected',
       fill = NULL) + 
       theme_minimal() +
  theme(legend.position = "top",
        plot.caption = element_text(color = "#3494ba", size = 11),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 11, color = 'black'),
        axis.title.y = element_text(margin = margin(r = 10, unit = "pt"), size = 11), 
        axis.title.x = element_text(margin = margin(t = 10, unit = "pt"), size = 11),
        text=element_text(family="Segoe UI", size=12))


```


```{r}

library(extrafont)

elections_final %>%
  filter(ano != 2000 & ano != 2016) |> 
  mutate(band_width = cut(margem_vitoria_mulher, breaks = seq(-1, 1, by = 0.01))) %>%
  group_by(band_width) %>%
  summarize(tx_homicidio_domestico = mean(tx_homicidio_domestico),
            tx_homicidio_geral = mean(tx_homicidio_geral),
            mulher_eleita = first(mulher_eleita)) %>%
  mutate(band_width = as.character(as.numeric(band_width) - 100),
         margem = as.numeric(band_width) - 0.5) %>%  
  ggplot(aes(margem, y = tx_homicidio_domestico, color = as.factor(mulher_eleita))) +
  geom_point() +
  geom_smooth(method = 'loess', se = FALSE, size = 1) +
  labs(title = 'Margem de Vitória e Homicídios de Mulheres',
       subtitle = 'Eleições entre Homens e Mulheres (2004 - 2012)',
       x = "Margem de Vitória de Mulheres (%)",
       y = "Taxa de Homicídios de Mulheres - Doméstico",
       color = NULL) +
  scale_color_manual(values = c("#7373ff", "#ff7373"),
                     labels = c("Homem Eleito", "Mulher Eleita")) + 
  theme_minimal() +
  theme(legend.position = "top",
        plot.caption = element_text(color = "#3494ba", size = 11),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 11, color = 'black'),
        axis.title.y = element_text(margin = margin(r = 10, unit = "pt"), size = 11), 
        axis.title.x = element_text(margin = margin(t = 10, unit = "pt"), size = 11),
        text=element_text(family="Segoe UI", size=12)) + 
  ylim(0, 5) +
  xlim(-20,20) 



```

```{r}

elections_final %>%
  filter(ano != 2000 & ano != 2016) |> 
  mutate(band_width = cut(margem_vitoria_mulher, breaks = seq(-1, 1, by = 0.01))) %>%
  group_by(band_width) %>%
  summarize(tx_homicidio_domestico_t1 = mean(tx_homicidio_domestico_t1),
            tx_homicidio_geral_t1 = mean(tx_homicidio_geral_t1),
            mulher_eleita = first(mulher_eleita)) %>%
  mutate(band_width = as.character(as.numeric(band_width) - 100),
         margem = as.numeric(band_width) - 0.5) %>%  
  ggplot(aes(margem, y = tx_homicidio_domestico_t1, color = as.factor(mulher_eleita))) +
  geom_point() +
  geom_smooth(method = 'loess', se = FALSE, size = 1) +
  labs(title = 'Margem de Vitória e Homicídios de Mulheres - Placebo',
       subtitle = 'Teste de Robustez - Eleições entre Homens e Mulheres (2004 - 2012)',
       x = "Margem de Vitória de Mulheres (%)",
       y = "Taxa de Homicídios de Mulheres - Doméstico (t-1)",
       color = NULL) +
  scale_color_manual(values = c("#7373ff", "#ff7373"),
                     labels = c("Homem Eleito", "Mulher Eleita")) + 
  theme_minimal() +
  theme(legend.position = "top",
        plot.caption = element_text(color = "#3494ba", size = 11),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 11, color = 'black'),
        axis.title.y = element_text(margin = margin(r = 10, unit = "pt"), size = 11), 
        axis.title.x = element_text(margin = margin(t = 10, unit = "pt"), size = 11),
        text=element_text(family="Segoe UI", size=12)) + 
  ylim(0, 5) +
  xlim(-20,20)

```

```{r}
mulher_pop <- read_xls('mulheres_na_pop.xls', sheet = 'Planilha1') |> 
  mutate(cd_muni = as.character(cd_muni))

reg_dom <- elections_final |> 
  filter(ano != 2000 & ano != 2016) |> 
  left_join(mulher_pop, by = c( 'codigo_ibge' = 'cd_muni', 'estado' = 'cd_estado')) |> 
  filter(codigo_ibge != 1504752)
```


```{r}

# REGRESSAO PRINCIPAL 


controls <- model.matrix(~ educacao_eleito + idade_eleito + partido_eleito + pop + Mulher + ano, data = reg_dom)

rd_robust_result <- rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                             covs = controls,
                             c = 0,
                             kernel= 'triangular',
                             h = 1,
                             cluster = reg_dom$codigo_ibge)

summary(rd_robust_result)

# bw (0.05) -> -1.875***
# bw (0.10) -> -1.203*
# bw cct (0.165) -> -0.876 . 
# bw (.25) -> -0.656 . 

rdplot(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                             covs = controls,
                             c = 0,
                             kernel= 'triangular')

                       
library(modelsummary)

summary(rd_robust_result)



```

```{r}

bandwidths <- seq(0.05, 1, by = 0.05)

betas <- numeric(length(bandwidths))
pvalues <- numeric(length(bandwidths))

for (i in seq_along(bandwidths)) {
  h <- bandwidths[i]
  rd_robust_result <- rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                               covs = controls,
                               c = 0,
                               kernel= 'triangular',
                               h = h)
  betas[i] <- rd_robust_result$coef[1]
  pvalues[i] <- rd_robust_result$pv[1]
}


results <- data.frame(
  bandwidth = bandwidths,
  beta = betas,
  pvalue = pvalues)

results |> 
  pivot_longer(beta:pvalue) |> 
  ggplot(aes(x=bandwidth, y = value)) + 
  geom_line() + 
  facet_grid(rows = vars(name), scales = "free_y") 
  

```

```{r}

library(patchwork) 

b <- results |> 
  ggplot(aes(x = bandwidth, y = beta)) +
  geom_line() + 
  theme_minimal() + 
  labs(title = 'LATE para diferentes Tamanhos de Banda na Margem de Vitoria',
       x = "Largura da banda da Margem de Vitória",
       y = "Efeito Causal de Ter uma mulher como Prefeita") + 
  theme(plot.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r = 10, unit = "pt"), size = 11), 
        axis.title.x = element_text(margin = margin(t = 10, unit = "pt"), size = 11),
        text=element_text(family="Segoe UI", size=12))

pv <- results |> 
  ggplot(aes(x = bandwidth, y = pvalue)) +
  geom_vline(xintercept = 0.165) +
  geom_line() + 
  theme_minimal()

pv + b

elections_final %>%
  filter(ano != 2000 & ano != 2016) |> 
  mutate(band_width = cut(margem_vitoria_mulher, breaks = seq(-1, 1, by = 0.01))) %>%
  group_by(band_width) %>%
  summarize(tx_homicidio_domestico_t1 = mean(tx_homicidio_domestico_t1),
            tx_homicidio_geral_t1 = mean(tx_homicidio_geral_t1),
            mulher_eleita = first(mulher_eleita)) %>%
  mutate(band_width = as.character(as.numeric(band_width) - 100),
         margem = as.numeric(band_width) - 0.5) %>%  
  ggplot(aes(margem, y = tx_homicidio_domestico_t1, color = as.factor(mulher_eleita))) +
  geom_point() +
  geom_smooth(method = 'loess', se = FALSE, size = 1) +
  labs(title = 'Close Elections and Violence Against Women - Robustness test',
       subtitle = 'Effects of having a Female Mayor (2004 - 2012)',
       x = "Women's Margin of Victory (%)",
       y = "Homicide Rates of Women - Domestic",
       color = NULL) +
  scale_color_manual(values = c("#90d2d8", "#f6a6b2"),
                     labels = c("Male Elected", "Female Elected")) + 
  theme_minimal() +
  labs(caption = "By InsperData") +
  theme(legend.position = "top",
        plot.caption = element_text(color = "#3494ba", size = 11),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 11, color = 'black'),
        axis.title.y = element_text(margin = margin(r = 10, unit = "pt"), size = 11), 
        axis.title.x = element_text(margin = margin(t = 10, unit = "pt"), size = 11),
        text=element_text(family="Segoe UI", size=12)) + 
  ylim(0, 5) +
  xlim(-15,15)

grid.arrange(pv, b)

```
# quanto maior a janela, os municipios deixam de ser comparaveis

```{r}
vicente <- rdplot(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
       c = 0,
       nbins = c(100, 100),
       kernel = 'triangular',
       h= 0.212,
       x.lim = c(-.15,.15),
       y.lim = c(0,5)) 

vicente$rdplot +
  labs(title = 'Close Elections and Violence Against Women',
       subtitle = 'Effects of having a Female Mayor (2004 - 2012)',
       x = "Women's Margin of Victory (%)",
       
       y = "Homicide Rates of Women - Domestic",
       color = NULL) +
  scale_color_manual(values = c("#90d2d8", "#f6a6b2"),
                     labels = c("Male Elected", "Female Elected")) + 
  theme_minimal() +
  labs(caption = "By InsperData") +
  theme(legend.position = "top",,
        
        plot.caption = element_text(color = "#3494ba", size = 11),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 11, color = 'black'),
        axis.title.y = element_text(margin = margin(r = 10, unit = "pt"), size = 11), 
        axis.title.x = element_text(margin = margin(t = 10, unit = "pt"), size = 11),
        text=element_text(family="Segoe UI", size=12)) + 
  ylim(0, 5) +
  xlim(-15,15)
```

```{r}


rdplot(reg_dom$tx_homicidio_domestico_t1, reg_dom$margem_vitoria_mulher,
       c = 0,
       nbins = c(100, 100),
       kernel = 'triangular',
       )
```


```{r}
rd_result <- RDestimate(tx_homicidio_domestico ~ margem_vitoria_mulher | 
                          educacao_eleito + 
                          partido_eleito +
                          pop +
                          Mulher,
                        data = reg_dom,
                        cutpoint = 0, 
                        kernel = 'rectangular',
                        bw = c(0.11, 0.221, .5, 1))


summary(rd_result)



```




```{r}
elections_final %>%
  mutate(band_width = cut(margem_vitoria_mulher, breaks = seq(-1, 1, by = 0.01))) %>%
  group_by(band_width) %>%
  summarize(tx_homicidio_domestico = mean(tx_homicidio_domestico),
            tx_homicidio_geral = mean(tx_homicidio_geral),
            mulher_eleita = first(mulher_eleita)) %>%
  mutate(band_width = as.character(as.numeric(band_width) - 100),
         margem = as.numeric(band_width) - 0.5) %>%  
  ggplot(aes(margem, y = tx_homicidio_geral, color = as.factor(mulher_eleita))) +
  geom_point() +
  geom_smooth(method = 'loess', se = FALSE, size = 1) +
  labs(title = 'Close Elections and Violence Against Women',
       subtitle = 'Effects of having a Female Mayor',
       x = "Women's Margin of Victory (%)",
       y = "Homicide Rates of Women",
       color = NULL) +
  scale_color_manual(values = c("#90d2d8", "#f6a6b2"),
                     labels = c("Male Elected", "Female Elected")) + 
  theme_minimal() +
  labs(caption = "By InsperData") +
  theme(legend.position = "top",
        plot.caption = element_text(color = "#3494ba", size = 11),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 11, color = 'black'),
        axis.title.y = element_text(margin = margin(r = 10, unit = "pt"), size = 11), 
        axis.title.x = element_text(margin = margin(t = 10, unit = "pt"), size = 11),
        text=element_text(family="Segoe UI", size=12)) + 
  xlim(-20, 20) +
  ylim(0, 7) 

```

```{r}
elections_final %>%
  filter(ano != 2000 & ano != 2016) |> 
  mutate(band_width = cut(margem_vitoria_mulher, breaks = seq(-1, 1, by = 0.01))) %>%
  group_by(band_width) %>%
  summarize(tx_homicidio_domestico_t1 = mean(tx_homicidio_domestico_t1),
            tx_homicidio_geral_t1 = mean(tx_homicidio_geral_t1),
            mulher_eleita = first(mulher_eleita)) %>%
  mutate(band_width = as.character(as.numeric(band_width) - 100),
         margem = as.numeric(band_width) - 0.5) %>%  
  ggplot(aes(margem, y = tx_homicidio_geral_t1, color = as.factor(mulher_eleita))) +
  geom_point() +
  geom_smooth(method = 'loess', se = FALSE, size = 1) +
  labs(title = 'Close Elections and Violence Against Women - Robustness test',
       subtitle = 'Effects of having a Female Mayor (2004 - 2012)',
       x = "Women's Margin of Victory (%)",
       y = "Homicide Rates of Women - Domestic",
       color = NULL) +
  scale_color_manual(values = c("#90d2d8", "#f6a6b2"),
                     labels = c("Male Elected", "Female Elected")) + 
  theme_minimal() +
  labs(caption = "By InsperData") +
  theme(legend.position = "top",
        plot.caption = element_text(color = "#3494ba", size = 11),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 11, color = 'black'),
        axis.title.y = element_text(margin = margin(r = 10, unit = "pt"), size = 11), 
        axis.title.x = element_text(margin = margin(t = 10, unit = "pt"), size = 11),
        text=element_text(family="Segoe UI", size=12)) + 
  ylim(0, 5) +
  xlim(-15,15)



```


```{r}
rd <- rdrobust(elections_final$tx_homicidio_geral, elections_final$margem_vitoria_mulher, c = 0)
# bw cct == 0.21

rdplot(elections_final$tx_homicidio_geral, elections_final$margem_vitoria_mulher, c = 0, nbins = c(100, 100), kernel = 'triangular' , h= 0.165, x.lim = c(-.15,0.15), y.lim = c(0,5))

rd_result <- RDestimate(tx_homicidio_geral ~ margem_vitoria_mulher | mulher_eleita + educacao_eleito + partido_eleito,
                        data = elections_final,
                        cutpoint = 0, 
                        kernel = 'rectangular')

```

## tabelas - descritiva
```{r}

elections_final |> 
  group_by(mulher_eleita) |> 
  summarise(n = n())


elections_final |> 
  filter(margem_vitoria_mulher <= 0.136 & margem_vitoria_mulher >= -0.136) |> 
  group_by(mulher_eleita) |> 
  summarise(n = n(),
            tx_homicidio_domestico = mean(tx_homicidio_domestico),
            tx_homicidio_geral = mean(tx_homicidio_geral),
            idade_eleito = mean(idade_eleito),
            total_votantes = mean(total_votantes), 
            total_abstencoes = mean(total_abstencoes), 
            pop = mean(pop))


elections_final |> 
  group_by(mulher_eleita) |> 
  summarise(n = n())

elections_final |> 
  group_by(mulher_eleita) |> 
  summarise(n = n(),
            tx_homicidio_domestico = mean(tx_homicidio_domestico),
            tx_homicidio_geral = mean(tx_homicidio_geral),
            total_votantes = mean(total_votantes), 
            total_abstencoes = mean(total_abstencoes), 
            pop = mean(pop))

elections_final |> 
  group_by(partido_eleito, mulher_eleita) |> 
  summarise(n = n()) |>
  mutate(representatividade_partido = case_when(mulher_eleita == TRUE ~ n/1315,
                                                mulher_eleita == FALSE ~ n/1802),
         representatividade_partido = round(representatividade_partido,4)) |> 
  filter(partido_eleito %in% c('PMDB', 'PSDB', 'PT' , 'PP'))
  

elections_final |> 
  group_by(partido_eleito) |> 
  summarise(n = n()) |> 
  arrange(desc(n))


elections_final |> 
  group_by(educacao_eleito) |> 
  summarise(n = n())


elections_final |> 
  group_by(educacao_eleito, mulher_eleita) |> 
  summarise(n = n())
  

elections_final |> 
  group_by(partido_eleito) |> 
  summarise(n = n()) |> 
  arrange(desc(n))

fund = c('ENSINO FUNDAMENTAL COMPLETO', 'ENSINO FUNDAMENTAL INCOMPLETO','FUNDAMENTAL COMPLETO', 'FUNDAMENTAL INCOMPLETO', 'LÊ E ESCREVE', 'NÃO INFORMADO')
med = c('MÉDIO COMPLETO', 'MÉDIO INCOMPLETO', 'ENSINO MÉDIO COMPLETO', 'ENSINO MÉDIO INCOMPLETO')
sup = c('SUPERIOR COMPLETO', 'SUPERIOR INCOMPLETO')

elections_final %>%
  mutate(edu_new = case_when(educacao_eleito %in% fund ~ 'Até Fundamental',
                             educacao_eleito %in% med ~ 'Até Médio',
                             educacao_eleito %in% sup ~ 'Até Superior')) %>%
  group_by(edu_new, mulher_eleita) %>%
  summarise(n = n()) |> 
  mutate(representatividade_educ = case_when(mulher_eleita == TRUE ~ n/1315,
                                                mulher_eleita == FALSE ~ n/1802),
         representatividade_educ = round(representatividade_educ,4))


elections_final |> 
  group_by(mulher_eleita) |> 
  summarise(idade = mean(idade_eleito),
            )
  


```
```{r}
elections_final |> 
  group_by(mulher_eleita) |> 
  summarize(n = n(),
            tx_homicidio_domestico = mean(tx_homicidio_domestico),
            tx_homicidio_geral = mean(tx_homicidio_geral),
            total_votantes = mean(total_votantes), 
            total_abstencoes = mean(total_abstencoes), 
            pop = mean(pop),
            mulher = mean(mulher_pop))


elections_final |> elections_final |> elections_final |> 
  group_by() |> 
  summarise(n = n())


```


## DEAMS
```{r}

library(haven)

df_deam <- read_dta("C:/Users/Dr_An/OneDrive/Área de Trabalho/Insper_Data/Close_election_Adriano/Dados/delegacias/womenservices.dta") |> 
  mutate(municipio = substr(as.character(muniyear), 1, 6)) %>%
  mutate(ano_deleg = muniyear %% 10000) |> 
  select(municipio, ano_deleg, everything(), -muniyear) |> 
  arrange(NumberOfDeams) |> 
  mutate(mandato_d = as.factor(case_when(ano_deleg <= 2000 ~ 1996,
                               ano_deleg <= 2004 ~ 2000,
                               ano_deleg <= 2008 ~ 2004,
                               ano_deleg <= 2012 ~ 2008,
                               ano_deleg <= 2016 ~ 2012,
                               ano_deleg <= 2020 ~ 2016,
                               ano_deleg <= 2024 ~ 2020,
                               .default = NA)),
         ano_deleg = as.factor(ano_deleg)) |> 
  group_by(municipio, mandato_d) |> 
  summarize(NumberOfDeams = max(NumberOfDeams)) |> 
  mutate(variacao_deams = NumberOfDeams - lag(NumberOfDeams)) |> 
  arrange(desc(variacao_deams)) 

```


```{r}

library(readxl)

munic_deams_2018 <- read_excel("C:/Users/Dr_An/OneDrive/Área de Trabalho/Insper_Data/Close_election_Adriano/Dados/munic_deams.xlsx") |> 
  mutate(cd_muni = as.character(cd_muni),
         mandato = 2012,
         mandato = as.factor(mandato))

reg_deam <- elections_final |> 
  left_join(df_deam, by = c('codigo_ibge_att' = 'municipio', 'ano' = 'mandato_d')) |> 
  left_join(munic_deams_2018, by = c('codigo_ibge' = 'cd_muni', 'ano' = 'mandato')) |> 
  mutate(NumberOfDeams = coalesce(NumberOfDeams, DEAM)) |> 
  group_by(codigo_ibge, ano) |> 
  mutate(NumberOfDeams = max(NumberOfDeams)) |> 
  ungroup() |> 
  group_by(codigo_ibge) |> 
  mutate(variacao_deams = NumberOfDeams - lag(NumberOfDeams)) |> 
  ungroup() |> 
  filter(ano != 2000 & ano != 2016) |> 
  mutate(implementou = case_when(variacao_deams > 0 ~ 1,
                                 variacao_deams == 0 ~ 0,
                                 .default = NA))



```

```{r}

reg_deam |> 
  filter(implementou > 0) |> 
  group_by(municipio, ano, estado) |> 
  summarize(n = n(),
            pop = mean(pop),
            NumberOfDeams = sum(NumberOfDeams),
            margem_vitoria_mulher = first(margem_vitoria_mulher),
            tx_homicidio_domestico = first(tx_homicidio_domestico),
            tx_homicidio_geral = first(tx_homicidio_geral)) |> 
  arrange(municipio)
  

resultado_logit <- glm(implementou ~ mulher_eleita, family = binomial(link = "logit"), data = reg_deam)

summary(resultado_logit)

reg_deam |> 
  filter(implementou > 0,
         margem_vitoria_mulher > -.166 & margem_vitoria_mulher < .166)


```


```{r}

deam <- reg_deam |> 
  filter(implementou >= 0,
         margem_vitoria_mulher > -0.163 & margem_vitoria_mulher < 0.163) |> 
    mutate(tem_delegacia = ifelse(NumberOfDeams > 0, 1, 0))


summary(rdrobust(deam$NumberOfDeams, deam$margem_vitoria_mulher,
                             c = 0,
                             kernel= 'triangular'))

reg_deam |> 
  mutate(tem_delegacia = ifelse(NumberOfDeams > 0, 1, 0))





deam |> count(NumberOfDeams)

```

```{r}

summary(rdrobust(deam$tem_delegacia, deam$margem_vitoria_mulher,
                             c = 0,
                             kernel= 'triangular'))



rdplot(deam$tem_delegacia, deam$margem_vitoria_mulher,
       c = 0,
       nbins = c(100, 100),
       kernel = 'triangular')
```

```{r}

# elections_info <- read.csv('elections_info.csv')
# candidates_info <- read.csv('candidates_info.csv')
# tse_ibge_muni <- read.csv('municipios_brasileiros_tse.csv')
# total_votantes <- read.csv('total_votantes.csv')


```


```{r}

# 
# candidatas <- elections_info %>%
#   mutate(qt_votos = case_when(ANO_ELEICAO == 2000 ~ QT_VOTOS_NOMINAIS_VALIDOS, .default = QT_VOTOS_NOMINAIS)) |>
#   rename(ano = ANO_ELEICAO,
#     estado = SG_UF,
#     cargo = DS_CARGO,
#     municipio = NM_MUNICIPIO,
#     cd_municipio = CD_MUNICIPIO,
#     zona = NR_ZONA,
#     candidato = NM_CANDIDATO,
#     votos = qt_votos) %>%
#   filter(ano >= 2000 & ano <= 2016,
#     cargo == 'Prefeito') |>
#   select(ano, estado,  municipio, cd_municipio, zona, candidato, votos) %>%
#   left_join(candidates, by = c('ano', 'estado', 'candidato')) |>
#   group_by(ano, estado, municipio, candidato) %>%
#   summarise(cd_municipio = first(cd_municipio),
#             votos_totais = sum(votos),
#             genero = first(genero),
#             partido = first(partido),
#             idade = first(idade),
#             educacao = first(educacao)) %>%
#   arrange(ano, estado, municipio, desc(votos_totais)) %>%
#   mutate(margem = votos_totais/sum(votos_totais)) %>%
#   group_by(ano, estado, municipio, candidato) %>%
#   summarise(
#     cd_municipio = first(cd_municipio),
#     nome_eleito = first(candidato),
#     partido_eleito = first(partido),
#     idade_eleito = first(idade),
#     educacao_eleito = first(educacao),
#     genero = first(genero),
#     margem = first(margem),
#     .groups = 'drop') %>%
#   select(ano, estado, municipio, everything()) |>
#   left_join(total_votantes, by=c('municipio', 'ano')) |>
#   left_join(tse_ibge_muni, by=c('cd_municipio' = 'codigo_tse')) |>
#   select(-uf, -nome_municipio, -capital)
#   
# 
# 
# c_eleitas <- candidatas  |> 
#   group_by(ano, estado, municipio, candidato) |> 
#   summarize(margem = first(margem)) |> 
#   arrange(estado, municipio, desc(margem)) |> 
#   mutate(eleito = if_else(row_number() == 1, "eleito", "não eleito")) |>
#   ungroup() |> 
#   arrange(ano, estado, municipio, desc(margem)) |> 
#   select(-margem)


```

```{r}



```

```{r}
library('gt')


```

```{r}
rd_robust_result <- rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'uniform')

summary(rd_robust_result)

```

```{r}
library(modelsummary)

 rdrobust(reg_dom$tx_homicidio_domestico,reg_dom$margem_vitoria_mulher) 

```

```{r}
models <- list(
  
  "(1)" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.05,
                 cluster = reg_dom$codigo_ibge
                 ),
  "(2)" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.10,
                 cluster = reg_dom$codigo_ibge
                 ),
  "(3)" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.165,
                 cluster = reg_dom$codigo_ibge
                 ),
  "(4)" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.25,
                 cluster = reg_dom$codigo_ibge
                 ),
  "(5)" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.4,
                 cluster = reg_dom$codigo_ibge
                 ),
  "(6)" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.7,
                 cluster = reg_dom$codigo_ibge
                 ),
  "(7)" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=1,
                 cluster = reg_dom$codigo_ibge
                 ),
  "(8)" =  rdrobust(reg_dom$tx_homicidio_domestico_t1, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.05,
                 cluster = reg_dom$codigo_ibge
                 ),
  "(9)" =  rdrobust(reg_dom$tx_homicidio_domestico_t1, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 cluster = reg_dom$codigo_ibge
                 ),
  "(10)" =  rdrobust(reg_dom$tx_homicidio_domestico_t1, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=1,
                 cluster = reg_dom$codigo_ibge
                 )
)
  

modelsummary(models)
```




```{r}
tidy.rdrobust <- function(model, ...) {
  ret <- data.frame(
    term = row.names(model$coef),
    estimate = model$coef[, 1],
    std.error = model$se[, 1],
    p.value = model$pv[, 1]
  )
  row.names(ret) <- NULL
  ret
}

glance.rdrobust <- function(model, ...) {
  ret <- data.frame(
    Kernel = model$kernel,
    Bandwidth = model$bws
  )
  ret
}
```


```{r}
models <- list(
  
  "Bandwidth: 0.05" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.05,
                 cluster = reg_dom$codigo_ibge
                 ),
  "Bandwidth: 0.1" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.10,
                 cluster = reg_dom$codigo_ibge
                 ),
  "Bandwidth: 0.165" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.165,
                 cluster = reg_dom$codigo_ibge
                 ),
  "Bandwidth: 0.25" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.25,
                 cluster = reg_dom$codigo_ibge
                 ),
  "Bandwidth: 0.4" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.4,
                 cluster = reg_dom$codigo_ibge
                 ),
  "Bandwidth: 0.7" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.7,
                 cluster = reg_dom$codigo_ibge
                 ),
  "Bandwidth: 1" =  rdrobust(reg_dom$tx_homicidio_domestico, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=1,
                 cluster = reg_dom$codigo_ibge
                 ),
  "Bandwidth: 0.05" =  rdrobust(reg_dom$tx_homicidio_domestico_t1, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=0.05,
                 cluster = reg_dom$codigo_ibge
                 ),
  "Bandwidth: CCT" =  rdrobust(reg_dom$tx_homicidio_domestico_t1, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 cluster = reg_dom$codigo_ibge
                 ),
  "Bandwidth: 1" =  rdrobust(reg_dom$tx_homicidio_domestico_t1, reg_dom$margem_vitoria_mulher,
                 covs = controls,
                 c = 0,
                 kernel= 'triangular',
                 h=1,
                 cluster = reg_dom$codigo_ibge
                 )
)
  

modelsummary(models)

```

```{r}

modelsummary(models, statistic = NULL, estimate = '{estimate} {stars}')

```

```{r}
library(gt)
```








